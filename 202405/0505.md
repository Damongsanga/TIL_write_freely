# TIL (Today I Learned)

# 5ì›” 5ì¼ ì¼ìš”ì¼

# ğŸ˜ƒÂ What I Learned

## âœ¨ì˜¤ëŠ˜ ì§„í–‰í•œ ë‚´ìš©

## ë¬´ì¤‘ë‹¨ ë°°í¬ ì„±ê³µ

[https://tech.xangle.io/backend/jenkins-cicd/#ì–´ë–¤-ë°©ë²•ìœ¼ë¡œ-ë¬´ì¤‘ë‹¨-ë°°í¬ë¥¼-í• -ìˆ˜-ìˆì„ê¹Œ](https://tech.xangle.io/backend/jenkins-cicd/#%EC%96%B4%EB%96%A4-%EB%B0%A9%EB%B2%95%EC%9C%BC%EB%A1%9C-%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC%EB%A5%BC-%ED%95%A0-%EC%88%98-%EC%9E%88%EC%9D%84%EA%B9%8C)

[https://tecoble.techcourse.co.kr/post/2022-11-01-blue-green-deployment/](https://tecoble.techcourse.co.kr/post/2022-11-01-blue-green-deployment/)

- ì™œ í•„ìš”?
    - 
- ì—¬ëŸ¬ ë¬´ì¤‘ë‹¨ ë°°í¬ ë°©ë²•
    - ë¸”ë£¨ê·¸ë¦°
        - ì‹œìŠ¤í…œ ìì› 2ë°°
        - ì†ì‰¬ìš´ ë¡¤ë°± ê°€ëŠ¥
    - ë¡¤ë§
        - ë°°í¬ ì¤‘ í˜¸í™˜ì„± ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
    - ì¹´ë‚˜ë¦¬
        - ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ì œì–´ì— ëŒ€í•œ ë¶€ë‹´
- ì™œ ë¸”ë£¨ê·¸ë¦°?
    - í”„ë¡œì íŠ¸ ì„œë²„ê°€ 1ê°œ (ë¶„ì‚°í˜• í”„ë¡œì íŠ¸ê°€ ì•„ë‹ˆì—ˆìŒ)
    - WS ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ ìƒˆë¡œìš´ ì„œë²„ë¥¼ ë„ì›Œ íŠ¸ë˜í”½ì„ ë¶„ì‚°í•˜ëŠ” ë°©ì‹ì€ ì í•©í•˜ì§€ ì•Šì•˜ìŒ
    - êµ¬ë²„ì „ í™˜ê²½ ì¬í™œìš©í•˜ê³  ë¡¤ë°±í•˜ê¸° ì‰¬ì›€
- ë”°ë¼ì„œ ë¸”ë£¨ê·¸ë¦° ë°°í¬ ë°©ì‹ì„ ì±„íƒí•˜ë˜ 1ëŒ€ì˜ ì„œë²„ì—ì„œ í¬íŠ¸ë¥¼ ë‚˜ëˆ„ì–´ nginx í”„ë¡ì‹œ ë°©í–¥ì„ ë‹¬ë¦¬í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ êµ¬í˜„

### ë°©ë²•ì€?

[https://kjw1313.tistory.com/86](https://kjw1313.tistory.com/86)

- **3002, 3003 ë²ˆ í¬íŠ¸ë¡œ 2ê°œì˜ was êµ¬ì„±**
- **í¬íŠ¸ë²ˆí˜¸ (ë‚˜ëŠ” upsteram) service-url.inc íŒŒì¼ì„ ë§Œë“¤ê³  í™˜ê²½ë³€ìˆ˜ë¡œ ë“±ë¡ â†’ í…ŒìŠ¤íŠ¸ ì™„ë£Œ**
- docker-compose.yml íŒŒì¼ì„ blue, greenë³„ë¡œ ë”°ë¡œ ë§Œë“¤ì–´ì•¼í•˜ëŠ” ê²ƒ ê°™ì€ë° ë°©ë²•ì„ ì°¾ì•„ë´ì•¼ í• ë“¯
- ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ êµ¬í˜„
    - ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì–´ë””ì— ìœ„ì¹˜? â‡’ ì–´ë””ë“  jenkinsê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê³³?
    1. blue, green ì¤‘ì—ì„œ ì–´ë–¤ ë²„ì „ì´ up ì¸ì§€ í™•ì¸
        - ì»¨íŠ¸ë¡¤ëŸ¬ ë‹¨ì—ì„œ í™•ì¸í•˜ëŠ” ë°©ë²•ì„ êµ¬í˜„í•´ì•¼í•˜ëŠ”ì§€
        - 
    
    ```bash
    jenkins@6952d928056f:~/settings$ docker-compose ps
     Name                Command                  State                                               Ports
    ------------------------------------------------------------------------------------------------------------------------------------------------
    back      java -jar /app.jar               Up (healthy)   0.0.0.0:3002->8080/tcp,:::3002->8080/tcp
    db        docker-entrypoint.sh mysqld      Up (healthy)   3306/tcp, 33060/tcp
    front     /docker-entrypoint.sh ngin ...   Up             0.0.0.0:3001->3001/tcp,:::3001->3001/tcp, 80/tcp
    jenkins   /usr/bin/tini -- /usr/loca ...   Up             0.0.0.0:50000->50000/tcp,:::50000->50000/tcp, 0.0.0.0:3100->8080/tcp,:::3100->8080/tcp
    redis     docker-entrypoint.sh redis ...   Up (healthy)   0.0.0.0:6379->6379/tcp,:::6379->6379/tcp
    
    ```
    
    1. down ë˜ì–´ìˆëŠ” í¬íŠ¸ë¥¼ ë¹Œë“œ
    2. í—¬ìŠ¤ì²´í¬
    3. í™•ì¸ë˜ë©´ service-url.inc ë³€ê²½í•˜ì—¬ í¬íŠ¸í¬ì›Œë”©í•˜ì—¬ ë²„ì „ ë³€ê²½
    4. ê¸°ì¡´ ë²„ì „ down

default.conf

```bash
upstream api-blue{ # ë¡œë“œë°¸ëŸ°ì‹±ì„ ìœ„í•¨ (í˜„ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë¶€í•˜ë¶„ì‚°í•  ì„œë²„ê°€ ì—†ìŒìœ¼ë¡œ ë¶ˆí•„ìš”í•˜ê¸´ í•˜ë‹¤)
 server urturn.site:3002;
}

upstream api-green{
 server urturn.site:3003;
}

server {
 listen 443 ssl;
 listen [::]:443 ssl;
 ssl_certificate /etc/zerossl/certificate.crt;
 ssl_certificate_key /etc/zerossl/private.key;

 include /etc/nginx/conf.d/service-url.inc;

 server_name urturn.site;

 access_log /var/log/nginx/nginx.vhost.access.log;
 error_log /var/log/nginx/nginx.vhost.error.log;

 location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;

        proxy_pass http://urturn.site:3001;
 }

  location /api { # /api ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì€ ê°œë°œìš© ì„œë²„ë¡œ
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass $service_url;
        proxy_set_header X-Forwarded-Prefix /api;
        proxy_pass_request_headers on;

  }

  location /wsapi/ {
        rewrite ^/wsapi/(.*)$ /$1 break;
        proxy_pass $service_url;

        #Websocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
  }

}

server {
           listen 80; listen [::]:80;
           server_name k10a206.p.ssafy.io urturn.site;
           return 301 https://urturn.site$request_uri;
}

server {
           listen 443; listen [::]:443;
           server_name k10a206.p.ssafy.io;
           return 301 https://urturn.site$request_uri;
}

```

service-url.inc

```bash
set $service_url http://api-blue;
```

docker-compose.yml

```bash
version: '3.1'

services:
  jenkins:
    container_name: jenkins
    networks:
      - urturn
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    image: ${JENKINS_IMAGE_NAME}
    restart: always
    ports:
      - "3100:8080"
      - "50000:50000"
    volumes:
      - /var/jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    user: jenkins

  db:
    container_name: db
    networks:
      - urturn
    image: mysql:8.0.36
    restart: always
    healthcheck:
      test: /bin/sh -c "mysqladmin ping -h db -u urturn -purturn"
      interval: 20s
      timeout: 5s
      retries: 5
      #start_period: 40s
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: urturn
      MYSQL_USER: urturn
      MYSQL_PASSWORD: urturn206!@
    volumes:
      - data_volume:/var/lib/mysql

  redis:
    container_name: redis
    hostname: redis
    networks:
      - urturn
    image: redis
    restart: always
    healthcheck:
      test: /bin/sh -c "redis-cli -h redis -a urturn!@ ping"
      interval: 20s
      timeout: 5s
      retries: 5
      #start_period: 40s
    command: redis-server --requirepass urturn!@ --port 6379
    ports:
    - "6379:6379"

      #  back:
      #container_name: back
      #build:
      #context: ./back
      #dockerfile: Dockerfile
      #image: ${BACK_IMAGE_NAME}:${IMAGE_TAG}
      #networks:
      #- urturn
      #restart: always
      #healthcheck:
      #test: "curl --fail --silent back:8080/actuator/health | grep UP || exit 1"
      #interval: 20s
      #timeout: 5s
      #retries: 5
      #start_period: 40s
      #ports:
      #- "3002:8080"
      #depends_on:
      #- db
      #- redis

  front:
    container_name: front
    networks:
      - urturn
    build:
      context: ./front
      dockerfile: Dockerfile
    image: ${FRONT_IMAGE_NAME}
    restart: always
    ports:
      - "3001:3001"
    volumes:
      - ./front/static:/usr/share/nginx/html
      - ./front/conf.d:/etc/nginx/conf.d
        #depends_on:
        #- back

volumes:
  data_volume:
    external: true

networks:
  urturn:
    external: true

```

docker-compose.blue.yml

```bash
version: '3.1'

services:
  back-blue:
    container_name: back-blue
    build:
      context: ./back
      dockerfile: Dockerfile
    image: ${BACK_IMAGE_NAME}:${IMAGE_TAG}
    networks:
      - urturn
    restart: always
    healthcheck:
      test: "curl --fail --silent back-blue:8080/actuator/health | grep UP || exit 1"
      interval: 20s
      timeout: 5s
      retries: 5
      #start_period: 40s
    ports:
      - "3002:8080"

networks:
  urturn:
    external: true

```

deploy.sh

```bash
#1
EXIST_BLUE=$(docker-compose -f /var/jenkins_home/settings/docker-compose.blue.yml ps | grep Up)
#EXIST_BLUE=$(docker ps -a --filter "name=back-blue" --filter "status=running")

if [ -z "$EXIST_BLUE" ]; then
    docker-compose -f /var/jenkins_home/settings/docker-compose.blue.yml up -d
    BEFORE_COLOR="green"
    AFTER_COLOR="blue"
    BEFORE_PORT=3003
    AFTER_PORT=3002
    BEFORE_UPSTREAM="api-green"
    AFTER_UPSTREAM="api-blue"

else
    docker-compose -f /var/jenkins_home/settings/docker-compose.green.yml up -d
    BEFORE_COLOR="blue"
    AFTER_COLOR="green"
    BEFORE_PORT=3002
    AFTER_PORT=3003
    BEFORE_UPSTREAM="api-blue"
    AFTER_UPSTREAM="api-green"

fi

echo "${AFTER_COLOR} server up(port:${AFTER_PORT})"

# 2
for cnt in {1..10}
do
    echo "ì„œë²„ ì‘ë‹µ í™•ì¸ì¤‘(${cnt}/10)";
    UP=$(curl -s http://back-${AFTER_COLOR}:8080/check)
    UP=$(curl -s http://localhost:${AFTER_PORT}/check)

 #   UP=$(curl --fail --silent back-${AFTER_COLOR}:8080/actuator/health)
    if [ -z "${UP}" ]
        then
            sleep 10
            continue
        else
            break
    fi
done

if [ $cnt -eq 10 ]
then
    echo "ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ êµ¬ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    exit 1
fi

# 3
sudo sed -i "s/${BEFORE_UPSTREAM}/${AFTER_UPSTREAM}/" /etc/nginx/conf.d/service-url.inc
sudo nginx -s reload
echo "Deploy Completed!!"

# 4
echo "$BEFORE_COLOR server down(port:${BEFORE_PORT})"
docker-compose -f /var/jenkins_home/settings/docker-compose.${BEFORE_COLOR}.yml down

```

## íŠ¸ëŸ¬ë¸” ìŠˆíŒ…

- ìƒí™©
    - ìƒˆë¡œìš´ íŒŒì¼ë“¤ì„ private-gitì— ê´€ë¦¬í•˜ì—¬ jenkinsë¡œ ì—…ë°ì´íŠ¸í•  ë•Œë§ˆë‹¤ ìë™ ë°˜ì˜ë˜ë„ë¡ í•˜ë ¤ê³  í–ˆëŠ”ë° permission deniedê°€ ë°œìƒ
- ì›ì¸
    - í™•ì¸í•´ë³´ë‹ˆ root ê¶Œí•œìœ¼ë¡œ íŒŒì¼ì„ ë§Œë“¤ì–´ë†¨ì–´ì„œ jenkinsê°€ í•´ë‹¹ íŒŒì¼ì„ ë®ì–´ì“°ê¸° í•˜ì§€ ëª»í–ˆì—ˆìŒ
- í•´ê²°ë°©ì•ˆ
    - íŒŒì¼ ê¶Œí•œ ì‚¬ìš©ìë¥¼ ubuntuë¡œ ë³€ê²½

```bash
ls -l /var/jenkins_home/settings
total 40
drwxr-xr-x 2 ubuntu ubuntu 4096 May  5 08:52 back
drwxr-xr-x 2 ubuntu ubuntu 4096 May  5 08:53 back@tmp
-rwxr-xr-x 1 ubuntu ubuntu 1515 May  5 15:47 default.conf
-rwxr-xr-x 1 root   root   1506 May  5 15:39 deploy.sh
-rwxr-xr-x 1 root   root    479 May  5 08:22 docker-compose.blue.yml
-rwxr-xr-x 1 root   root    482 May  5 08:22 docker-compose.green.yml
-rwxr-xr-x 1 ubuntu ubuntu 2120 May  5 15:47 docker-compose.yml
drwxr-xr-x 4 ubuntu ubuntu 4096 May  3 04:29 front
drwxr-xr-x 2 ubuntu ubuntu 4096 Apr 26 17:05 jenkins
-rwxr-xr-x 1 ubuntu ubuntu   34 May  5 15:47 service-url.inc

sudo chown ubuntu:ubuntu docker-compose.green.yml
sudo chown ubuntu:ubuntu docker-compose.blue.yml
sudo chown ubuntu:ubuntu deploy.sh

ls -l /var/jenkins_home/settings
total 40
drwxr-xr-x 2 ubuntu ubuntu 4096 May  5 08:52 back
drwxr-xr-x 2 ubuntu ubuntu 4096 May  5 08:53 back@tmp
-rwxr-xr-x 1 ubuntu ubuntu 1515 May  5 15:47 default.conf
-rwxr-xr-x 1 ubuntu ubuntu 1506 May  5 15:39 deploy.sh
-rwxr-xr-x 1 ubuntu ubuntu  479 May  5 08:22 docker-compose.blue.yml
-rwxr-xr-x 1 ubuntu ubuntu  482 May  5 08:22 docker-compose.green.yml
-rwxr-xr-x 1 ubuntu ubuntu 2120 May  5 15:47 docker-compose.yml
drwxr-xr-x 4 ubuntu ubuntu 4096 May  3 04:29 front
drwxr-xr-x 2 ubuntu ubuntu 4096 Apr 26 17:05 jenkins
-rwxr-xr-x 1 ubuntu ubuntu   34 May  5 15:47 service-url.inc

```

## âœ¨ë‚´ì¼ ì§„í–‰í•  ë‚´ìš©

- [ ]  API ëª…ì„¸ì— DTO ìì„¸í•˜ê²Œ ê¸°ë¡ í•„ìš” â†’ ì°½ì§„ì´í•œí…Œ ë¬¼ì–´ë´ì„œ ê¸°ë¡í•˜ê¸°
- [ ]  github API History ì €ì¥ í›„ì— ë¬´ì¡°ê±´ ë™ì‘í•˜ë„ë¡ í•˜ê³  ì•ˆë˜ë©´ ì—ëŸ¬ì²˜ë¦¬í•˜ëŠ”ê±¸ë¡œ
    - [x]  github access token refresh ë¡œì§ êµ¬ì„±
        - [ ]  ì–´ë–»ê²Œ ì—°ë™í• ê±´ì§€ ê³ ë¯¼í•´ì•¼í•¨
        - [ ]  ì—°ë™ì‹œì— ë§Œì•½ repositoryê°€ nullì´ë©´ ê·¸ëƒ¥ ìš”ì²­í•˜ì§€ ì•ŠëŠ”ê±¸ë¡œ ë¶„ê¸°
    - [ ]  History ê¸°ë°˜ìœ¼ë¡œ ì–´ë–»ê²Œ ë„£ì„ì§€
    - [ ]  ì´ë¦„ ì–´ë–»ê²Œ ë„£ì„ì§€
    - [ ]  commit message ì–´ë–»ê²Œ ë„£ì„ì§€ (ë‚ ì§œ + ê°™ì´ í‘¼ ì‚¬ëŒ ë“± ë„£ìœ¼ë©´ ë ë“¯)?
    - [ ]  ì‘ë‹µê°’ string ë§ê³  ì–´ë–¤ê±° ë„£ì„ì§€

## âœ¨ë°°ìš´ ë‚´ìš©

# ğŸ˜œÂ Todayâ€™s Small Happiness

# ğŸ§Â Letâ€™s Think About It

# ğŸ™€Â Got Stuck..