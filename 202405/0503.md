# TIL (Today I Learned)

# 5ì›” 3ì¼ ê¸ˆìš”ì¼

# ğŸ˜ƒÂ What I Learned

## âœ¨ì˜¤ëŠ˜ ì§„í–‰í•œ ë‚´ìš©

- [x]  ì˜¤í”ˆë¹„ë‘ ì„¤ì¹˜ ë° ì—°ê²° í™•ì¸
    - [x]  [https://openvidu.discourse.group/t/what-is-err-connection-refused-error/375](https://openvidu.discourse.group/t/what-is-err-connection-refused-error/3758)
    
    **[WARN] 2024-05-01 10:16:29,026 [main] io.openvidu.server.OpenViduServer - You have set property server.port (or SERVER_PORT). This will serve OpenVidu Server on your host at port 5443. But property HTTPS_PORT (8443) still configures the port that should be used to connect to OpenVidu Server from outside. Bear this in mind when configuring a proxy in front of OpenVidu Server**
    
    [https://openvidu.discourse.group/t/4443-service-connection-refused/3149/2](https://openvidu.discourse.group/t/4443-service-connection-refused/3149/2)
    
    ./openvidu report
    
    [openvidu react](https://velog.io/@ohsg97/openVidu-tutorial-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0)
    
    ```bash
    OpenVidu ì„¤ì¹˜
    í¬íŠ¸ ì„¤ì •
    ufw allow ssh
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw allow 3478/tcp
    ufw allow 3478/udp
    ufw allow 40000:57000/tcp
    ufw allow 40000:57000/udp
    ufw allow 57001:65535/tcp
    ufw allow 57001:65535/udp
    
    í´ë” ì´ë™ ë° ì„¤ì¹˜
    cd /opt
    curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | bash
    
    SSL ì ìš©
    cd /opt/openvidu/owncert
    # ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ë³µì‚¬ í›„ í•´ë‹¹ í´ë”ì— ë¶™ì—¬ë„£ê¸°
    # ì´ë¦„ì„ certificate.cert, certificate.keyë¡œ ë³€ê²½í•´ì¤˜ì•¼í•¨!
    
    OpenVidu ì„¤ì • ë³€ê²½
    cd /opt/openvidu
    sudo vi .env
    
    ë³€ê²½ì‚¬í•­ ì ìš© í›„ restart
    DOMAIN_OR_PUBLIC_IP=urturn.site
    OPENVIDU_SECRET=A206
    CERTIFICATE_TYPE=owncert
    HTTP_PORT=4442
    HTTPS_PORT=4443
    ```
    
- [x]  websocket

### ì—ëŸ¬ : WebSocket connection to 'wss://urturn.site/wsapi/ws' failed:

**ì›ì¸ :** 

1. ì›¹ì†Œì¼“ì„ HTTPSë¡œ í•˜ë ¤ë©´ wsê°€ ì•„ë‹Œ wss ì„¤ì •ì„ í•´ì•¼í•¨
2. nginxì—ì„œ ë¼ìš°íŒ…ì„ í•˜ë©´ì„œ websocketì´ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •í•´ì•¼í•¨

**ì£¼ì˜ :** 

ì—”ë“œí¬ì¸íŠ¸ê°€ ws/ ë¡œ ì‹œì‘í•´ì„œ í—·ê°ˆë¦´ ìˆ˜ ìˆì§€ë§Œ í†µì‹ ì€ wssë¡œ ë°›ì•„ì•¼ í•¨!

backì—ì„œëŠ” ì—”ë“œí¬ì¸íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì‘ë™í•¨ìœ¼ë¡œ spring security, registerStompEndpointsë¥¼ ëª¨ë‘ wsë¡œ í•´ì•¼ í•¨

**ì°¸ê³  :**

[nginx ì„¤ì •](https://www.google.com/search?q=nginx+wss+websocket&oq=nginx+wss+websocket&gs_lcrp=EgZjaHJvbWUyCAgAEEUYHhg5MggIARAAGAgYHjIICAIQABgIGB4yCggDEAAYCBgKGB4yCggEEAAYgAQYogQyCggFEAAYgAQYogQyCggGEAAYgAQYogQyCggHEAAYgAQYogQyCggIEAAYgAQYogQyCAgJEAAYCBge0gEJODQzNmowajE1qAIAsAIA&sourceid=chrome&ie=UTF-8)

nginx

```bash
server {
 listen 443 ssl;
 listen [::]:443 ssl;
 ssl_certificate /etc/zerossl/certificate.crt;
 ssl_certificate_key /etc/zerossl/private.key;

 server_name urturn.site;

 access_log /var/log/nginx/nginx.vhost.access.log;
 error_log /var/log/nginx/nginx.vhost.error.log;

 location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;

        proxy_pass http://urturn.site:3001;
 }

  location /api { 
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://ssafy;
        proxy_set_header X-Forwarded-Prefix /api;
        proxy_pass_request_headers on;
  }

  location /wsapi/ { # ìƒˆë¡œ ê²½ë¡œë¥¼ ë§Œë“¤ì–´ì„œ websocket ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •í•´ì¤˜ì•¼í•¨
        rewrite ^/wsapi/(.*)$ /$1 break;
        proxy_pass http://ssafy;

        #Websocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
  }

}

```

security config

```java
.authorizeHttpRequests(authorize -> authorize
                        // í•´ë‹¹ APIì— ëŒ€í•´ì„œëŠ” ëª¨ë“  ìš”ì²­ì„ í—ˆê°€
                        .requestMatchers("/ws/**", "/app/**", "/auth/reissue", "/auth/oauth2/login/github", "/auth/test/login", "/actuator/health", "/swagger-ui/**", "/v3/api-docs/**", "/v3/api-docs", "/auth/oauth2/token").permitAll() ///auth/oauth2/token ì‚­ì œ í•„ìš”
                        // ì´ ë°–ì— ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ì„œ ì¸ì¦ì„ í•„ìš”ë¡œ í•œë‹¤ëŠ” ì„¤ì •
                        .anyRequest().authenticated())
```

handler

```java
@Configuration
@EnableWebSocketMessageBroker
@RequiredArgsConstructor
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

@Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")
                .setAllowedOrigins("*");
}
```

- [x]  ì±„ì  ì„œë¹„ìŠ¤ êµ¬í˜„
    - [ ]  API ëª…ì„¸ì— DTO ìì„¸í•˜ê²Œ ê¸°ë¡ í•„ìš” â†’ ì°½ì§„ì´í•œí…Œ ë¬¼ì–´ë´ì„œ ê¸°ë¡í•˜ê¸°

- [x]  [refresh token reissue í•„í„°ë‹¨ì—ì„œ ì§„í–‰ë˜ë„ë¡ ë¡œì§ ì¬êµ¬ì„±](https://velog.io/@solchan/%EB%B0%B1%EC%97%85-Refresh-Token-%EB%B0%9C%EA%B8%89%EA%B3%BC-Access-Token-%EC%9E%AC%EB%B0%9C%EA%B8%89)

## âœ¨ë‚´ì¼ ì§„í–‰í•  ë‚´ìš©

- [ ]  github API History ì €ì¥ í›„ì— ë¬´ì¡°ê±´ ë™ì‘í•˜ë„ë¡ í•˜ê³  ì•ˆë˜ë©´ ì—ëŸ¬ì²˜ë¦¬í•˜ëŠ”ê±¸ë¡œ
    - [x]  github access token refresh ë¡œì§ êµ¬ì„±
        - [ ]  ì–´ë–»ê²Œ ì—°ë™í• ê±´ì§€ ê³ ë¯¼í•´ì•¼í•¨
        - [ ]  ì—°ë™ì‹œì— ë§Œì•½ repositoryê°€ nullì´ë©´ ê·¸ëƒ¥ ìš”ì²­í•˜ì§€ ì•ŠëŠ”ê±¸ë¡œ ë¶„ê¸°
    - [ ]  content ì–´ë–»ê²Œ Base64ë¡œ ë„£ì„ì§€
    - [ ]  History ê¸°ë°˜ìœ¼ë¡œ ì–´ë–»ê²Œ ë„£ì„ì§€
    - [ ]  ì´ë¦„ ì–´ë–»ê²Œ ë„£ì„ì§€
    - [ ]  commit message ì–´ë–»ê²Œ ë„£ì„ì§€ (ë‚ ì§œ + ê°™ì´ í‘¼ ì‚¬ëŒ ë“± ë„£ìœ¼ë©´ ë ë“¯)?
    - [ ]  ì‘ë‹µê°’ string ë§ê³  ì–´ë–¤ê±° ë„£ì„ì§€

## âœ¨ë°°ìš´ ë‚´ìš©

# ğŸ˜œÂ Todayâ€™s Small Happiness

# ğŸ§Â Letâ€™s Think About It

# ğŸ™€Â Got Stuck..