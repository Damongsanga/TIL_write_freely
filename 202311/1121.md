# TIL (Today I Learned)

# 11ì›” 21ì¼ ì¼ìš”ì¼

# ğŸ˜ƒÂ What I Learned

# ì¶”ê°€ ê³µë¶€ ë‚´ìš©

1. [Java Supplier<T>](https://www.notion.so/Supplier-8ee1a0c0ee7e492da9c46a9c9ef84c50?pvs=21)
2. [Reactor Flux, Mono](https://www.notion.so/Java-Reactor-Mono-Flux-79bccda6702249a4b89517f8ca10fb48?pvs=21)

# Session & Cookie í™œìš©í•œ ë¡œê·¸ì¸ êµ¬í˜„
ì°¸ì¡° [https://chb2005.tistory.com/175]

- í•´ë‹¹ í”„ë¡œì íŠ¸ì—ëŠ” ë¡œê·¸ì¸ ì •ë³´ì— ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ë‹¤

### ì„¸ì…˜ ë§¤ë‹ˆì €

```java
package com.ssafypjt.bboard.session;

import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.stereotype.Component;
import java.util.Arrays;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class SessionManager {

    // ì¿ í‚¤ë¥¼ ì“¸ ê³³ì´ ë§ê¸° ë•Œë¬¸ì— ìƒìˆ˜ë¡œ ë§Œë“¦
    public static final String SESSION_COOKIE_NAME = "mySessionId";

    // ìŠ¤í”„ë§ ì•„ì´ë””ì™€ ê°ì²´ë¥¼ ë§µìœ¼ë¡œ ì €ì¥
    // ë™ì‹œì„±ì„ ìœ„í•´ ConcurrentHashMap<>() ì‚¬ìš©
    private Map<String, Object> sessionStore = new ConcurrentHashMap<>();
    
    public void createSession(Object value, HttpServletResponse response) {

        // ì„¸ì…˜ idë¥¼ ìƒì„±í•˜ê³ , ê°’ì„ ì„¸ì…˜ì— ì €ì¥
        // randomUUID() : í™•ì‹¤í•œ ëœë¤ê°’ì„ ì–»ì„ ìˆ˜ ìˆìŒ. ìë°”ê°€ ì œê³µ
        String sessionId = UUID.randomUUID().toString();
        sessionStore.put(sessionId, value);

        // ì¿ í‚¤ ìƒì„±
        Cookie mySessionCookie = new Cookie(SESSION_COOKIE_NAME, sessionId);
        mySessionCookie.setPath("/"); // ëª¨ë“  ê²½ë¡œì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        mySessionCookie.setMaxAge(3600); // ì¿ í‚¤ì˜ ìœ íš¨ ì‹œê°„ì„ ì„¤ì • (ì´ˆ ë‹¨ìœ„, ì˜ˆ: 1ì‹œê°„)
        response.addCookie(mySessionCookie);
    }
    
    public Object getSession(HttpServletRequest request) {
        // ì¿ ê¸°ë¥¼ ì°¾ìŒ
        Cookie sessionCookie = findCookie(request, SESSION_COOKIE_NAME);
        if (sessionCookie == null) {
            return null;
        }
        System.out.println(sessionCookie.getValue());
        return sessionStore.get(sessionCookie.getValue());
    }
    
    public void expire(HttpServletRequest request) {
        Cookie sessionCookie = findCookie(request, SESSION_COOKIE_NAME);
        if (sessionCookie != null) {
            // ë§Œë£Œëœ ì¿ í‚¤ë¥¼ ì§€ì›€
            sessionStore.remove(sessionCookie.getValue());
        }
    }
    
    public Cookie findCookie(HttpServletRequest request, String cookieName) {
        if (request.getCookies() == null) {
            return null;
        }
        return Arrays.stream(request.getCookies())
                .filter(cookie -> cookie.getName().equals(cookieName))
                .findAny()
                .orElse(null);
    }

}
```

```java
package com.ssafypjt.bboard.session;

public class SessionConst {
    public static final String LOGIN_MEMBER = "loginMember";
}
```

### í™œìš©

- **ì„¸ì…˜ ìƒì„± ì½”ë“œ**

```java
@GetMapping("login/{userName}")
public ResponseEntity<?> login(@PathVariable String userName,
                               @SessionAttribute(name = SessionConst.LOGIN_MEMBER, required = false) Integer userId,
                               HttpServletResponse response){
    response.setContentType("text/html;charset=UTF-8");
    User user = userService.getUserByName(userName);
    if (user == null) return new ResponseEntity<Void>(HttpStatus.NO_CONTENT);
    sessionManager.createSession(user.getUserId(), response);
    return new ResponseEntity<User>(user, HttpStatus.OK);
}
```

- **ì„¸ì…˜ í™œìš© ì½”ë“œ**

```java
@GetMapping("/group") // ë¡œê·¸ì¸ëœ ìœ ì €ì˜ ê·¸ë£¹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    public ResponseEntity<?> getGroups(HttpServletRequest request){
        int userId = (Integer) sessionManager.getSession(request);
        List<Group> list = groupService.getGroups(userId);
        list.forEach(group -> group.setPassword(group.getPassword().replaceAll(".", "*")));

        if (list == null) return new ResponseEntity<Void>(HttpStatus.NO_CONTENT);
        return new ResponseEntity<List<Group>>(list, HttpStatus.OK);
    }
```

# ëŒ€ëŸ‰ ë°ì´í„° Insert with for each script

```java
@Insert({
        "<script>",
        "INSERT IGNORE INTO problem_algorithm (problem_num, algorithm) VALUES ",
        "<foreach item='item' collection='list' separator=','>",
        "(#{item.problemAlgorithm.problemNum}, #{item.problemAlgorithm.algorithm})",
        "</foreach>",
        "</script>"
})
public int insertAlgorithms(List<ProblemAndAlgoObjectDomain> list);
```

```sql
INSERT INTO `car` (vin, modelname, date_of_manufacture, mileage, manufacturer_code)
VALUES 
('KMHXX00XXXX000000', 'ì†Œë‚˜íƒ€', '2018-05-01', 20000 ,100),
('KMHXX00XXXX000001', 'ì•„ë°˜ë–¼', '2021-12-25', 1000, 100),
('KNHXX00XXXX000000', 'K-5' ,'2017-12-10', 35000,200),
('KNHXX00XXXX000001', 'ì˜ë Œí† ','2010-08-01', 100000,200),
('1G1ZE5ST1HF199624', 'ë§ë¦¬ë¶€','2020-01-10', 5000, 300);
```

# SpringBoot 3.0ì—ì„œ Swagger ì‚¬ìš©ë²•

- **application.properties**

```
#swagger
springdoc.swagger-ui.enabled=true
```

- **build.gradle**

```
implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.0.2' 
implementation 'org.springdoc:springdoc-openapi-ui:1.7.0'
```

- **SwaggerConfig**

```java
@Configuration
@OpenAPIDefinition(
		info = @Info(title = "User-Service API ëª…ì„¸ì„œ",
				description = "ì‚¬ìš©ì ì–´í”Œ ì„œë¹„ìŠ¤ API ëª…ì„¸ì„œ",
				version = "v1"))
public class SwaggerConfig {

	@Bean
	public GroupedOpenApi chatOpenApi() {
		String[] paths = {"/v1/**"};

		return GroupedOpenApi.builder()
				.group("COUPLE API v1")
				.pathsToMatch(paths)
				.build();
	}

}
```

## ì˜¤ëŠ˜ êµ¬í˜„ ë‚´ìš©

1. GroupController ì„¸ë¶€ë¡œì§ êµ¬í˜„ ë° TEST ì™„ë£Œ
2. SQL ëŒ€ëŸ‰ ì‚½ì… í•œë²ˆì— ë„£ëŠ” ë¡œì§ êµ¬í˜„ ì™„ë£Œ
3. UserTierProblem ì‘ì„±í•  ë•Œ ë ˆë²¨ 5ê°œê¹Œì§€ëŠ” ìœ„ ì•„ë˜ë¡œ ê°€ê¹Œìš´ ê°’ìœ¼ë¡œë¼ë„ ì±„ìš°ê¸° (ì™„ë£Œ)
4. User ë“±ë¡ì‹œ 1ê°œì˜ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” Domain ì‘ì„± ì™„ë£Œ (í…ŒìŠ¤íŠ¸ í•„ìš”)
5. Controller ë“±ë¡ ì™¸ ê°ì²´ ìƒì„±í•˜ì—¬ ìš”ì²­ -> idë§Œ ë„£ì–´ì„œ ìš”ì²­í•˜ë„ë¡ ìˆ˜ì • ì™„ë£Œ
6. Swagger ë“±ë¡ ì™„ë£Œ
7. ë°ì´í„° ì¼ê´€ì„± issue í•´ê²°!? ê³ ë¯¼ ì•ˆí•´ë„ ë ë“¯
8. Session & Cookie í™œìš©í•œ ë¡œê·¸ì¸ êµ¬í˜„ ì™„ë£Œ

## ë‚´ì¼ í•  ì¼

1. Recom ë¬¸ì œ ë“±ë¡ ì§„í–‰ì¤‘

> ë‚´ê°€ í‘¼ ìƒìœ„ 100ë¬¸ì œì¤‘ì—ì„œ ì¶”ì²œí•˜ê¸°
problemServiceImplì—ì„œ addRecomProblem ìˆ˜ì • í•„ìš”
> 
1. login page ë§Œë“¤ì–´ë³´ê¸°

ì¶”ê°€ ê³ ë¯¼
ì•Œê³ ë¦¬ì¦˜ì´ ì—†ëŠ” ê²½ìš° ì–´ë–»ê²Œ í•˜ëŠ”ê°€?

# ğŸ˜œÂ Todayâ€™s Small Happiness

- ì˜¤ëŠ˜ êµ¬í˜„ ë§ì´í•¨!
- ê³µë¶€í•˜ëŠ” ì¦ê±°ì›€ì´ ëŠê»´ì§!

# ğŸ§Â Letâ€™s Think About It

- ì¿ í‚¤, ì„¸ì…˜ì— ëŒ€í•´ ì¡°ê¸ˆ ë” ê³µë¶€í•´ë³´ì

# ğŸ™€Â Got Stuck..

- springì— ë¹„í•´ vueì— ëŒ€í•œ ì´í•´ë„ê°€ ë§ì´ ë–¨ì–´ì§„ë‹¤.. ã…  ë‹¹ì—°í•œ ê±°ê¸´ í•¨!