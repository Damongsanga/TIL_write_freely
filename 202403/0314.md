# TIL (Today I Learned)

# 3ì›” 14ì¼ ëª©ìš”ì¼

# ğŸ˜ƒÂ What I Learned

## âœ¨ì˜¤ëŠ˜ ì§„í–‰í•œ ë‚´ìš©

- [x]  íŒŒì´í”„ë¼ì¸ ì‘ì„±ì¤‘
    - [x]  docker ì´ë¯¸ì§€ ë§Œë“¤ê¸° â‡’ ì—ì„œ ë§‰í˜. ë³´ë‹ˆê¹Œ docker ì‚¬ìš©ê¶Œí•œì´ ì—†ê±°ë‚˜ ì œëŒ€ë¡œ ë³¼ë¥¨ë§ˆìš´íŠ¸ ë˜ì§€ ì•Šì€ ë“¯
        
        ```bash
        + docker build . -t damongsanga/springboot:53
        /var/jenkins_home/workspace/test_pipeline_1@tmp/durable-15e7bb77/script.sh.copy: 1: docker: not found
        ```
        
    
    [ì£¼ìš” ì°¸ê³  ë¸”ë¡œê·¸](https://enginnersnack.tistory.com/11)
    
    - [x]  **í•´ê²°í•¨ jenkinsì— ë„ì»¤ ì•ˆê¹œ ê°œì›ƒê²¨**
- [x]  ì¼ë‹¨ mysql ë„ìš°ê¸°
    - ë‚´ìš©
        - ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸°
            
            ```bash
            # ìˆ˜ì •
            docker volume create data_volume
            docker pull mysql:8.0.36
            docker run -d -p 3200:3306 -e MYSQL_DATABASE=flowermari -e MYSQL_USER=flowermari -e MYSQL_PASSWORD=flowermari -e MYSQL_ROOT_PASSWORD=root -v data_volume:/var/lib/mysql --name db-dev mysql:8.0.36
            ```
            
        - db í™•ì¸í•˜ê¸°
            
            ```bash
            mysql -h [í˜¸ìŠ¤íŠ¸] -u [ì‚¬ìš©ì] -p
            mysql -h localhost -u root -p
            mysql -h localhost -u flowermari -p
            
            SHOW DATABASES;
            ```
            
- [x]  ì¼ë‹¨ front ì„œë²„ ë„ìš°ê³  ë¹Œë“œ íŒŒì¼ ë„ì›Œì£¼ê¸°
    - [x]  front nginx ì„¤ì • (/settingsì— ë³¼ë¥¨ë§ˆìš´íŠ¸í•˜ê³  /usr/share/nginx/htmlë¡œ ì´ë™
    - [x]  default.conf ì„¤ì •
        - ì˜¬ë°”ë¥¸ default.conf
            
            ```bash
            server {
                listen 3001;
                server_name j10a704.p.ssafy.io;
            
                access_log /var/log/nginx/nginx.vhost.access.log;
                error_log /var/log/nginx/nginx.vhost.error.log;
            
                location / {
                root /usr/share/nginx/html/static;
                index index.html;
                try_files $uri $uri/ =404;
            	}
            
            }
            ```
            
        - **ë¶ˆí•„ìš”í•œ í”„ë¡ì‹œê°€ ë“¤ì–´ê°„ default.conf**
            - try_files $uri $uri/ @proxy; ëœ»ì€ uriì— ìˆëŠ” íŒŒì¼ì´ë‚˜ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ê³ , ì•„ë‹ˆë©´ @proxyë¡œ ê°€ë„ë¡ í•˜ëŠ” ê²ƒì¸ë° ì˜ëª» ì‚¬ìš©í•¨
            - ìš°ë¦¬ëŠ” SPAì„ìœ¼ë¡œ ë‹¤ë¥¸ ì •ì íŒŒì¼ì„ ì œê³µí•  í•„ìš”ê°€ ì—†ìŒ
                
                ```bash
                try_files $uri $uri/ =404;
                ->
                try_files $uri $uri/ /index.html =404; # ì´ë ‡ê²Œ ë§ê³  ê·¸ëƒ¥ indexë¥¼ ìœ„ë¡œ ëºŒ
                ```
                
                ```bash
                server {
                    listen 3001;
                    server_name j10a704.p.ssafy.io;
                
                    access_log /var/log/nginx/nginx.vhost.access.log;
                    error_log /var/log/nginx/nginx.vhost.error.log;
                
                    location / {
                        root /usr/share/nginx/html/static;
                        index index.html;
                        try_files $uri $uri/ @proxy;
                    }
                
                    location @proxy {
                        proxy_pass http://j10a704.p.ssafy.io:3000;
                        }
                
                }
                ```
                
    - [x]  í˜¸ìŠ¤íŠ¸ nginx ì„¤ì •
        - í˜¸ìŠ¤íŠ¸ nginx default.conf
            
            ```bash
            
            server {
             listen 443 ssl;
             listen [::]:443 ssl;
             ssl_certificate /etc/zerossl/certificate.crt;
             ssl_certificate_key /etc/zerossl/private.key;
            
             server_name j10a704.p.ssafy.io;
            
             access_log /var/log/nginx/nginx.vhost.access.log;
             error_log /var/log/nginx/nginx.vhost.error.log;
            
             location / {
                    proxy_pass http://j10a704.p.ssafy.io:3001;
             }
            }
            
            server {
                       listen 80; listen [::]:80;
                       server_name j10a704.p.ssafy.io;
                       return 301 https://$host$request_uri;
            }
            ```
            

### spring ë¹Œë“œ ë° image ë°°í¬ íŒŒì´í”„ë¼ì¸

- íŠ¸ëŸ¬ë¸” ìŠˆíŒ…
    1. Dockerfile ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ì–´ì„œ
        
        ```bash
        FROM openjdk:17
        
        # Jar íŒŒì¼ì„ ì´ë¯¸ì§€ ë‚´ë¶€ì— ë³µì‚¬
        COPY ./*.jar /app.jar
        
        ARG JAR_FILE_PATH=backend/build/libs/*.jar
        COPY ${JAR_FILE_PATH} app.jar
        
        # í•´ë‹¹ Docker imageë¡œ Containerë¥¼ ìƒì„±/ì‹¤í–‰í•˜ëŠ” ì‹œì ì— ì•„ë˜ì˜ ì»¤ë§¨ë“œê°€ ìˆ˜í–‰ë˜ë„ë¡ í•œë‹¤.
        CMD ["java",  "-jar", "/app.jar"]
        ```
        
    2. Docker hub credentials ë³€ìˆ˜ ì§€ì • ë¬¸ì œ. credentialsì€ ì§€ì • ì˜í–ˆëŠ”ë° environment í™œìš© ì˜ ëª»í•¨
    - ì°¸ê³  : [https://kanoos-stu.tistory.com/55](https://kanoos-stu.tistory.com/55)
    - **íŒŒì´í”„ë¼ì¸**
        
        ```bash
        pipeline {
            agent any
            
            environment {
              dockerHubRegistry = 'damongsanga/springboot'
              dockerHubRegistryCredential = 'docker-hub'
            }
        
            stages {
                    
                stage('gitlab clone'){
                    steps {
                        deleteDir()
                        script {
                            git credentialsId: 'gitlab_token_private', 
                            branch: "master",
                            url: 'https://lab.ssafy.com/mike0413lata/flowermari_private.git'
                        }
                        
                        script{
                            sh '''
                                    mkdir ./files
                                    mv ./Dockerfile ./files/Dockerfile
                                    mv ./application/application.yml ./files/application.yml
                               '''
                        }
                        
                        script {
                            git credentialsId: 'gitlab_accesstoken', 
                            branch: "back-dev",
                            url: 'https://lab.ssafy.com/s10-bigdata-recom-sub2/S10P22A704.git'
                        }
                    }
                    post {
                        failure {
                          echo 'Repository clone failure !'
                        }
                        success {
                          echo 'Repository clone success !'
                        }
                    }
                }
        
                stage('build') {
                        steps {
                            dir('backend'){
                                    sh'''
                                        echo build start!
                                        mv ../files/application.yml .
                                        chmod +x gradlew
                                        ./gradlew clean bootJar
                                        echo build completed!
                                    '''
                                }
                        }
                        post {
                            failure {
                              echo 'Gradle jar build failure !'
                            }
                            success {
                              echo 'Gradle jar build success !'
                            }
                    }
                }
                
                stage('Docker Image Build') {
                    steps {
                        sh "mv ./files/Dockerfile Dockerfile"
                        sh "docker build . -t ${dockerHubRegistry}:${currentBuild.number}"
                        sh "docker build . -t ${dockerHubRegistry}:latest"
                    }
                    post {
                            failure {
                              echo 'Docker image build failure !'
                            }
                            success {
                              echo 'Docker image build success !'
                            }
                    }
            }
        
            stage('Docker Image Push') {
                    steps {
                        script{
                            docker.withRegistry('', dockerHubRegistryCredential) {
                                sh "docker push ${dockerHubRegistry}:${currentBuild.number}"
                                sh "docker push ${dockerHubRegistry}:latest"
                                sleep 10 /* Wait uploading */
                            }
                        }
        
                    }
                    post {
                            failure {
                              echo 'Docker Image Push failure !'
                            }
                            success {
                              echo 'Docker image push success !'
                            }
                    }
            }
            }
        }
        
        ```
        

# Front ë°°í¬

## DockerFile ì•ˆì“°ê³  í”„ë¡ íŠ¸ ë§Œë“¤ê¸°

- jenkinsì—ì„œ front ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸°

```bash
docker run -td --user=root -v /var/jenkins_home/settings/front:/settings -p 3001:3001 --name web nginx:1.25.3
```

- npm install
    - node_modulusì— ì˜ì¡´ì„± ì„¤ì¹˜
- npm run build
    - dist í´ë”ì— ë‹´ê¹€
- dist íŒŒì¼ ë°›ì•„ì„œ front containerë¡œ ë„£ì–´ì¤Œ
    - usr/share/nginx/html/static ì— ë„£ì–´ë‘ 
        
        ```bash
        docker exec -it front sh -c 'mv /settings/* /usr/share/nginx/html/static'
        ```
        

## DockerFile ì“°ë©´?

### nginx + react + docker + jenkins

```docker
FROM node:20.11.0-alpine as builder	# ë…¸ë“œë²„ì „ 20.11.0
WORKDIR /app	# ì‘ì—… ìœ„ì¹˜ ì§€ì •
ENV PATH /app/node_modules/.bin:$PATH	# í™˜ê²½ë³€ìˆ˜ ì§€ì •

COPY . /app	#í˜„ì¬ íŒŒì¼ì„ ì´ë¯¸ì§€ì˜ /app ìœ„ì¹˜ì— ë³µì‚¬
RUN npm install	#package.jsonì— ëª…ì‹œëœ ì˜ì¡´ì„± ì„¤ì¹˜
RUN npm run build	#ë¹Œë“œì‹œì‘!

#nginx 
FROM nginx:1.25.3
RUN rm -rf /etc/nginx/conf.d	#ê¸°ì¡´ í™˜ê²½ì„¤ì • ì œê±°
COPY conf /etc/nginx	#ë‚´ ë””ë ‰í† ë¦¬ì˜ confí´ë” ë‚´ìš©ì„ ë³µì‚¬
	#í˜„ì¬ìœ„ì¹˜/conf/conf.d/default.conf ê°€ ì¡´ì¬í•´ì•¼í•©ë‹ˆë‹¤.
COPY --from=builder /app/build /usr/share/nginx/html	#builderë¡œ ë¶€í„° /app/buildë¥¼ ë³µì‚¬í•´ì˜µë‹ˆë‹¤.

# 80ë²ˆ í¬íŠ¸ë¥¼ ë…¸ì¶œí•œë‹¤ê³  ì¨ë†¨ì§€ë§Œ, ì´ëŠ” ëª…ì‹œí•˜ê¸° ìœ„í•œ ê²ƒìœ¼ë¡œ ë°˜ë“œì‹œ docker runì˜ ì˜µì…˜ìœ¼ë¡œ í¬íŠ¸
# ë§¤í•‘ì„ í•´ì•¼í•©ë‹ˆë‹¤.

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## ë™ê±´ í—¬í”„

- dockerfile & docker-compose ì„¸íŒ…í•˜ê¸°
    - var/jenkins_home/settingsì— docker-compose yml íŒŒì¼
    - ì—¬ê¸° í•˜ìœ„ì— front. back ë“±ì— Dockerfile ë‚˜ëˆ ì„œ ê´€ë¦¬
    - ìŠ¤í¬ë¦½íŠ¸ì— ìˆëŠ” ëŒ€ë¶€ë¶„ì˜ ë‚´ìš©ì„ Dockerfileë¡œ ê´€ë¦¬ ê°€ëŠ¥í•˜ë‹¤!
- ì´ë¯¸ì§€ ë¹Œë“œ?
    - -f ì˜µì…˜ìœ¼ë¡œ ë„ì»¤ íŒŒì¼ ìœ„ì¹˜ ì§€ì •í•´ì„œ ë¹Œë“œ ê°€ëŠ¥í•˜ë‹¤
- ssl ì¸ì¦ì„œëŠ” ê²Œì´íŠ¸ì›¨ì´ì—
    - ë‚´ë¶€ì ì¸ í†µì‹ ì€ ëª¨ë‘ httpë¡œ í•˜ë©´ ëœë‹¤
- Docker Volume?
    - ì˜ì†ì„± ê´€ë¦¬ë¥¼ ìœ„í•´ ë„ì»¤ì—ì„œ ê´€ë¦¬í•˜ëŠ” ì €ì¥ì†Œë¡œ í˜¸ìŠ¤íŠ¸ì— ì €ì¥ë¨
    - ì¼ì¢…ì˜ í™˜ê²½ë³€ìˆ˜ì²˜ëŸ¼ ë°ì´í„° ì €ì¥í•˜ëŠ” ì €ì¥ì†Œ

## ê¸°íƒ€

- **ì  í‚¨ìŠ¤ ë‚´ ë„ì»¤ ì„¤ì¹˜**
    
    ì  í‚¨ìŠ¤ ë‚´ ë„ì»¤ ì„¤ì¹˜ì‹œ docker-cli ì•ˆê¹”ë¦¬ëŠ” ë¬¸ì œ í•´ê²°
    
    ```bash
    curl -fsSL https://get.docker.com -o get-docker.sh
    
    sudo sh get-docker.sh
    
    sudo usermod -aG docker $USER
    
    logout
    
    sudo apt install docker-compose
    ```
    

## âœ¨ë‚´ì¼ ì§„í–‰í•  ë‚´ìš©

- [ ]  back íŒŒì´í”„ë¼ì¸ ë§ˆì € ì–´ë–»ê²Œ í• ì§€?
- [ ]  node js ì•ˆê¹”ë¦¬ëŠ” ë¬¸ì œ í•´ê²°í•´ë³´ê¸°
    
    nodejs ë²„ì „ì„ 20.11.0ìœ¼ë¡œ ëª…ì‹œí•˜ì—¬ ìë™ìœ¼ë¡œ nodejs.orgì—ì„œ install ë˜ë„ë¡ ì„¤ì •í•˜ì…¨ëŠ”ë° ì € ì—ëŸ¬ë¡œ installì´ ë˜ì§€ ì•Šê³  ìˆëŠ”ê²Œ ì•„ë‹Œì§€ ì‹¶ìŠµë‹ˆë‹¤
    
- [ ]  ì  í‚¨ìŠ¤ ë©€í‹°ë¸Œëœì¹˜ ì „ëµ ê³µë¶€
    
    [https://creampuffy.tistory.com/202](https://creampuffy.tistory.com/202)
    

## âœ¨ë°°ìš´ ë‚´ìš©

## âœ¨ë¸”ë¡œê·¸ ê¸€ ì‘ì„±

# ğŸ˜œÂ Todayâ€™s Small Happiness

# ğŸ§Â Letâ€™s Think About It

- **ì»¨ì„¤í„´íŠ¸ë‹˜ê»˜ ì—¬ì­¤ë³¼ê¹Œ? í˜„ì¬ ë°© ì¸ì›ìˆœìœ¼ë¡œ ì •ë ¬ í˜ì´ì§•?**

# ğŸ™€Â Got Stuck..

- ì´ê±° ì—ëŸ¬ ì™œìƒê¸°ëŠ”ê±¸ê¹Œ..