# TIL (Today I Learned)

# 2ì›” 2ì¼ ê¸ˆìš”ì¼

# ğŸ˜ƒÂ What I Learned

## í”„ë¡œì íŠ¸ 20ì¼ì°¨

### ì§„í–‰ ë‚´ìš©

**ê¹ƒ dev ë¡œì»¬ì—ì„œ pullí•˜ê³  ë¨¸ì§€í•´ì„œ conflict í•´ê²°í•˜ê³  ë¨¸ì§€í•˜ì**

### ì˜¤ëŠ˜ í•œ ë‚´ìš©

- [x]  redis ë°ì´í„° êµ¬ì¡° ê³ ë¯¼
    - [x]  ë°©id : [ìœ ì € id : ì…ì¥ì‹œê°„] êµ¬ì¡°ë¡œ?
- [x]  transform & groupbyë¥¼ ì‚¬ìš©í•œ ì¡°ì¸ ì¿¼ë¦¬ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì ìš©í•  ë§Œí•œì§€ ê²€í† 
    - [x]  ì´ê²Œ ì´ì œ ë°©ì…ì¥ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ë°.. í•„ìš”í•œê°€? ë„ˆë¬´ ë§ìŒ
    - [x]  ê°€ì ¸ì˜¬ ë°ì´í„° ìˆ˜ê°€ ë§ì§€ ì•Šì€ ì±„ë„, ë¼ìš´ì§€ì •ë„ëŠ” ê´œì°®ì„ë“¯
    - [x]  í‚¤ì›Œë“œ..ë„ ê´œì°®ì„ì§€ë„ â†’ NONO ë£¸-ë£¸í‚¤ì›Œë“œ-í‚¤ì›Œë“œë¡œ ê°€ì ¸ì™€ì„œ ë°ì´í„°ê°€ ë„ˆë¬´ ë§ì„ë“¯
- [x]  ë°© ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    - [x]  ë°© keyword ì„œë¸Œì¿¼ë¦¬? ì ìš©
    - [x]  typeì€ ë„˜ê²¨ì¤„ í•„ìš”ê°€ ì—†ì–´ë³´ì„. ì§€ì›€
    - [x]  í˜„ì¬ ë°© ëª‡ëª…ì¸ì§€ë„ ë„˜ê²¨ì¤˜ì•¼í•¨ - redis ì„¤ê³„ë¶€í„° ë¨¼ì €í•˜ì
- [x]  XSS ê³µê²© ëŒ€ë¹„ë¥¼ ìœ„í•œ í† í° ì¿ í‚¤ ì €ì¥ ë¡œì§
    
    [https://velog.io/@cksrb63/JWT-ê·¸ë¦¬ê³ -XSS-CSRF](https://velog.io/@cksrb63/JWT-%EA%B7%B8%EB%A6%AC%EA%B3%A0-XSS-CSRF)
    
    [https://velog.io/@xogml951/Refresh-Tokenì„-ì–´ë””ì—-ì €ì¥í•´ì•¼-í• ê¹ŒFeat.-XSS-CSRF-CORS](https://velog.io/@xogml951/Refresh-Token%EC%9D%84-%EC%96%B4%EB%94%94%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%B4%EC%95%BC-%ED%95%A0%EA%B9%8CFeat.-XSS-CSRF-CORS)
    
    1. CSRFë°©ì§€ë¥¼ ìœ„í•´ Refererì²´í¬, CSRFí† í° ê²€ì¦ë“±ì˜ ê³¼ì •ì„ ì¶”ê°€í•´ì•¼
    

### ë‚´ì¼ í•  ë‚´ìš©

- [ ]  ë°©ê²€ìƒ‰ ì°¸ì—¬ì¸ì›ìˆ˜ (mysql, redis ì—°ë™) ë¡œì§ ê³ ë¯¼
- [ ]  ì¹´í”„ì¹´ ì„¸íŒ… ì‹œë„
- [ ]  ë¦¬íŒ©í† ë§
    - [ ]  ì—ëŸ¬ ë©”ì‹œì§€ êµ¬ì²´í™”

### ë°°í¬ ì‹œ ìˆ˜ì •í•  ë‚´ìš©

- [ ]  ê°œë°œ ëë‚˜ê³  ìˆ˜ì •í•  ë‚´ìš©
    - [ ]  METADATA ì‘ì„± ìµœì†Œ ì‹œê°„ 5ì´ˆ â†’ 5ë¶„ ë¯¸ë§Œìœ¼ë¡œ ìˆ˜ì •
    - [ ]  `GlobalExceptionHandler` `@ExceptionHandler(RestApiException.class)` printstacktrace ì‚­ì œ

## í•´ë³¸ ë‚´ìš©

[redis transaction](https://sabarada.tistory.com/178)

### Transform & Groupbyë¥¼ í†µí•œ DTO ë³€í™˜

```java
@Override
    public RoomResponseDto enterRoomCustom(Long roomId) {
        RoomResponseDto res = jpaQueryFactory.select(
                        Projections.constructor(RoomResponseDto.class,
                                room.id,
                                member.memberId,
                                member.nickname,
                                room.title,
                                room.description,
                                room.link,
                                room.roomImage,
                                room.mcount,
                                room.capacity,
                                room.isLocked,
                                room.password,
                                room.constraints,
                                room.type
                        )
                ).
                from(room).
                leftJoin(room.manager, member).
                where(room.id.eq(roomId).and(room.manager.eq(member))).fetchOne();

        if (res == null) return null;
				
				// ì¶”ê°€ ì¿¼ë¦¬ 4ê°œ
        res.setMembers(getMembers(roomId));
        res.setLounges(getLounges(roomId));
        res.setChannels(getChannels(roomId));
        res.setKeywords(getKeywords(roomId));

        return res;
    }
```

```java
@Override
    public RoomResponseDto enterRoomCustom(Long roomId) {
        RoomResponseDto res = jpaQueryFactory.selectFrom(room)
                .leftJoin(room.manager, member)
                .leftJoin(room.channels, channel)
                .leftJoin(room.lounges, lounge)
                .leftJoin(room.roomKeywords)
                .where(room.id.eq(roomId).and(room.manager.eq(member)))
                .transform(
                        groupBy(room.id).as(
                                Projections.constructor(
                                        RoomResponseDto.class,
                                        room.id,
                                        member.memberId,
                                        member.nickname,
                                        room.title,
                                        room.description,
                                        room.link,
                                        room.roomImage,
                                        room.mcount,
                                        room.capacity,
                                        room.isLocked,
                                        room.password,
                                        room.constraints,
                                        room.type,
                                        list(Projections.constructor(
                                                RoomChannelResponseDto.class,
                                                channel.id,
                                                channel.name
                                        )),
                                        list(Projections.constructor(
                                                RoomLoungeResponseDto.class,
                                                lounge.id,
                                                lounge.name
                                        ))
                                )
                        )).get(roomId);

        if (res == null) return null;

				// ì¶”ê°€ ì¿¼ë¦¬ 2ê°œ (roomMember, roomKeywordì˜ ì¤‘ê°„ í…Œì´ë¸”ì´ ìˆì–´ì„œ ê±°ê¸°ì„œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ë” ìœ ë¦¬)
        res.setMembers(getMembers(roomId));
        res.setKeywords(getKeywords(roomId));
        return res;
    }
```

### ì„œë¸Œì¿¼ë¦¬ë¡œ count ì‘ì„±

- JPA SubqueryëŒ€ì‹  JPAExpression ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤

```java
private void followCount(MemberDetailResponseDto res, String memberId) {
    Tuple tuple = jpaQueryFactory.select(
                    JPAExpressions.select(
                            count(follow.from)).from(follow)
                            .where(follow.from.memberId.eq(memberId)),
                    JPAExpressions.select(
                            count(follow.to)).from(follow)
                            .where(follow.to.memberId.eq(memberId))
                    ).from(follow)
                .fetchOne();
    if(tuple == null) return;

    res.setFollowerCount(tuple.get(0, Long.class).intValue());
    res.setFollowingCount(tuple.get(1, Long.class).intValue());
}
```

```java
private BooleanExpression eqKeywordIds(List<Long> keywordIds) {
        if (keywordIds == null || keywordIds.isEmpty()) return null;

        // ì£¼ì–´ì§„ keyword idë¥¼ ëª¨ë‘ ê°€ì§€ê³  ìˆëŠ” roomì˜ idë¥¼ ì„ íƒ
        JPQLQuery<Long> subQuery = JPAExpressions
                .select(roomKeyword.room.id)
                .from(roomKeyword)
                .leftJoin(roomKeyword.keyword)
                .where(roomKeyword.keyword.id.in(keywordIds))
                .groupBy(roomKeyword.room.id)
                .having(roomKeyword.keyword.id.count().eq((long) keywordIds.size()));

        return room.id.in(subQuery);
    }
```

## XSS ë°©ì§€ë¥¼ ìœ„í•œ ì¿ í‚¤ì— refreshToken ë„£ì–´ì„œ ë³´ë‚´ê¸°

[https://www.notion.so/JWT-XSS-CSRF-samesite-CORS-4e29e1abcdc740bf848a89cf983b51c8?pvs=4](https://www.notion.so/JWT-XSS-CSRF-samesite-CORS-4e29e1abcdc740bf848a89cf983b51c8?pvs=21)

## ë°°ìš´ ë‚´ìš©

## ë„ì»¤, ê°€ìƒí™”

[https://www.notion.so/101-e48d9a5e590f47bdaf1c486e62d6d5ae?pvs=4](https://www.notion.so/101-e48d9a5e590f47bdaf1c486e62d6d5ae?pvs=21)

## ì•Œê³ ë¦¬ì¦˜

**[ì¹´ì¹´ì˜¤ì¸í„´ 2024] n+1 ì¹´ë“œê²Œì„ ëª»í’ˆ â‡’ ë°¤ì— í’ˆ!**

# ğŸ˜œÂ Todayâ€™s Small Happiness

# ğŸ§Â Letâ€™s Think About It

- ë ˆë””ìŠ¤ì— ìˆëŠ” ì¡°ê±´ìœ¼ë¡œ ì •ë ¬.. querydslì— ì–´ë–»ê²Œ ì ìš©í•˜ì§€
- querydslì´ ì•ˆë˜ë©´ JPQLìœ¼ë¡œë¼ë„ í•´ì•¼í•˜ëŠ”ë°.. ë§¤ìš°â€¦ë§¤ìš°.. í˜ë“¤ê²ƒê°™ì€ë°â€¦

# ğŸ™€Â Got Stuck..