# TIL (Today I Learned)

# 1ì›” 25ì¼ ëª©ìš”ì¼

# ğŸ˜ƒÂ What I Learned

## í”„ë¡œì íŠ¸ 14ì¼ì°¨

### ì§„í–‰ ë‚´ìš©

### ì˜¤ëŠ˜ í•œ ë‚´ìš©

- [x]  spring security with redis ê³µë¶€ (ì–´ë””ì— í† í° ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ”ê°€? â‡’ Spring Context?)
    - [x]  í† í° ì •ë³´ëŠ” redis. spring contextëŠ” ë§¤ë²ˆ filterì—ì„œ authorizeí•  ë•Œ ìœ ì € ì •ë³´ë¥¼ ë„£ì–´ì¤€ë‹¤
- [x]  í† í° ê²€ì‚¬ ë©”ì»¤ë‹ˆì¦˜ ì •í™•í•œ ì´í•´ì™€ access token ë§Œë£Œì— ë”°ë¥¸ ì¬ë°œê¸‰ ë¡œì§ êµ¬í˜„
- [x]  ë¡œê·¸ì•„ì›ƒ êµ¬í˜„

### ë‚´ì¼ í•  ë‚´ìš©

- [ ]  token ì¶”ê°€ ì•”í˜¸í™” (accessë„ ì•„ë‹ˆë©´ refresh ë™ì‹œì—?)

[https://green-bin.tistory.com/50](https://green-bin.tistory.com/50)

[https://green-bin.tistory.com/76](https://green-bin.tistory.com/76)

- [ ]  filter ë‹¨ì—ì„œì˜ custom error í™•ì¸

- [ ]  Refactoring
    - [ ]  DTO & SERVICE ë“± convention í†µì¼
    - [ ]  @Where Entityì— ì ìš©í•˜ê³  findByIdAndIsDeletedFalse ì „ë¶€ findByIdë¡œ ìˆ˜ì •í•˜ê¸°
    - [ ]  EnterRoomì— Keywordë„ ì¶”ê°€

## ì˜¤ëŠ˜ ë§‰íŒ ë¶€ë¶„

- ë§ˆì§€ë§‰ì— ë¹„ì •ìƒì ì¸ access tokenì„ ë³´ëƒˆì„ ë•Œ ë¦¬í„´ ì—ëŸ¬ê°’ì´ custom error í˜•ì‹ì´ ì•„ë‹˜
    - ë¡œì§ í™•ì¸ í•„ìš”

## í•´ê²°í•œ ë¶€ë¶„

### REDIS í™œìš©í•œ Refresh token ì €ì¥

**ë³´ì•ˆ & ì‚¬ìš©ì ê²½í—˜ì„ ê³ ë ¤í•˜ì—¬ ì—¬ëŸ¬ Login êµ¬í˜„ ë°©ë²• ì¤‘ 2ë²ˆì„ ì„ íƒí•˜ì˜€ë‹¤**

1. **ì™„ì „í•œ Stateless Pure JWT**
    - DB ì‚¬ìš© X
2. **Access Token ë§Œë£Œì‹œê°„ ì§§ê²Œ + RefreshToken DB ê´€ë¦¬ ( â† ì‚¬ìš©)**
    - **ë¡œê·¸ì•„ì›ƒ ì‹œì—ë§Œ DBì„œ ì‚­ì œ**
3. **Access Token & RefreshToken ëª¨ë‘ DB ê´€ë¦¬**
    - ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ, ë‹¤ë¥¸ ìš”ì²­ ëª¨ë‘ DB ì €ì¥/ì‚­ì œ
4. **ê·¸ëƒ¥ ì„¸ì…˜ ì‚¬ìš©**
    - ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ, ë‹¤ë¥¸ ìš”ì²­ ëª¨ë‘ DB

**êµ¬í˜„ ë°©ë²•**

- Server ë‹¨ì—ì„œ memberId(key) : refresh token(value) í˜•íƒœë¡œ ì €ì¥
- login : memberId, password ë¥¼ ê¸°ë°˜ìœ¼ë¡œí•˜ëŠ” JwtToken ìƒì„±

```java
@Transactional
    public JwtToken login(String memberId, String password) {

        // DBì—ì„œ ìœ ì € ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ëŠ”ì§€ í™•ì¸
        memberIdAndPasswordValidation(memberId, password);

        // 1. username(memberId) + password ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Authentication ê°ì²´ ìƒì„±
        // ì´ë•Œ authentication ì€ ì¸ì¦ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” authenticated ê°’ì´ false
        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(memberId, password);

        // 2. ì‹¤ì œ ê²€ì¦. authenticate() ë©”ì„œë“œë¥¼ í†µí•´ ìš”ì²­ëœ Member ì— ëŒ€í•œ ê²€ì¦ ì§„í–‰
        // authenticate ë©”ì„œë“œê°€ ì‹¤í–‰ë  ë•Œ CustomUserDetailsService ì—ì„œ ë§Œë“  loadUserByUsername ë©”ì„œë“œ ì‹¤í–‰
        Authentication authentication = authenticationManagerBuilder.getObject().authenticate(authenticationToken);
        log.info("{}", authentication.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.joining(",")));
        // 3. ì¸ì¦ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ JWT í† í° ìƒì„±
        JwtToken jwtToken = jwtTokenProvider.generateToken(authentication);

        return jwtToken;
    }

private void memberIdAndPasswordValidation(String memberId, String password) {
        Member member = memberRepository.findByMemberIdAndIsDeletedFalse(memberId).orElseThrow(() -> new RestApiException(CustomErrorCode.LOGIN_FAIL));
        if (!member.getPassword().equals(passwordEncoder.encode(password))) new RestApiException(CustomErrorCode.LOGIN_FAIL);
    }
```

- logout : redisì—ì„œ memberIdë¥¼ keyë¡œ ê°€ì§€ëŠ” refresh tokenì„ ì‚­ì œ

```java
@Transactional
    public void logout(String memberId){
        jwtRedisRepository.delete(memberId);
        // ì¶”ê°€ì ìœ¼ë¡œ redisì— ìœ ì €ê°€ ì…ì¥í•´ìˆëŠ” ë°© ì •ë³´ë„ ì‚­ì œí•´ì£¼ë©´ ëœë‹¤
    }
```

- reissue : refresh tokenì„ í™œìš©í•œ access token ì¬ë°œê¸‰

```java
public String reissueAccessToken(String refreshToken) {
        // ìœ ì €ê°€ ì œê³µí•œ refreshTokenì´ ìˆëŠ”ì§€ í™•ì¸
        if (refreshToken == null) throw new RestApiException(CustomErrorCode.HEADER_REFRESH_TOKEN_NOT_EXISTS);

        // userId ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ redisì— ìˆëŠ” refreshtokenê³¼ ê°™ì€ì§€ í™•ì¸
        Claims claims = jwtTokenProvider.parseClaims(refreshToken);
        String memberId = claims.getSubject();
        log.info("{}", memberId);
        String redisRefreshToken = jwtRedisRepository.getRefreshToken(memberId);
        if (redisRefreshToken == null || !redisRefreshToken.equals(refreshToken)) throw new RestApiException(CustomErrorCode.INVALID_REFRESH_TOKEN);
        // ê°™ë‹¤ë©´ refreshTokenì„ í™œìš©í•˜ì—¬ ìƒˆë¡œìš´ accessTokenì„ ë°œê¸‰
        return jwtTokenProvider.generateAccessToken(memberId, claims.get("auth").toString());
    }
```

- login ì‹œ jwtToken ë°œê¸‰

![Untitled](TIL%20(Today%20I%20Learned)%201fec48ac4832486f99527b3bbe49bc41/Untitled.png)

- refresh tokenì„ í¬í•¨í•œ reissue api í˜¸ì¶œì‹œ access token ë°˜í™˜

![Untitled](TIL%20(Today%20I%20Learned)%201fec48ac4832486f99527b3bbe49bc41/Untitled%201.png)

## ê³µë¶€í•˜ë‹¤ ì•ˆ ê²ƒë“¤

# With Redis

- **why redis?**
    1. FAST
        
        ì¸ë©”ëª¨ë¦¬ DBë¡œ ë§¤ìš° ë¹ ë¥´ê²Œ serch/update/deleteê°€ ê°€ëŠ¥í•˜ë‹¤
        
    2. EASY
        
        ê°€ì¥ í° ì´ìœ ëŠ” RedisëŠ” TTL(Time-To-Live) ê¸°ëŠ¥ì„ ì œê³µí•˜ê¸° ë•Œë¬¸ì— ë°ì´í„°ì˜ ë§Œë£Œ ì‹œê°„ì„ ì„¤ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸
        
        **ì„œë²„ì— ì €ì¥í•  Refresh Tokenì˜ ë§Œë£Œ ì‹œê°„ì„ ì‰½ê²Œ ì„¤ì •**
        
- **ì‚¬ìš© ì˜ˆì‹œ**
    - **ë¡œê·¸ì¸**
        - accessTokenì„ ë°œê¸‰ ë°›ê³ , **refreshTokenì„ Redisì— ì €ì¥í•œë‹¤**
        - purely statelessí•œ ë°©ë²•ì´ ì•„ë‹ˆë‹¤
    - **ë¡œê·¸ì•„ì›ƒ**
        - **accessTokenì˜ ë‚¨ì€ ìœ íš¨ê¸°ê°„ ë™ì•ˆ redisì— logoutAccessTokenì„ ì €ì¥**í•˜ì—¬ í•´ë‹¹ í† í°ìœ¼ë¡œ ì ‘ê·¼ í•˜ëŠ” ê²ƒì„ ê¸ˆì§€ì‹œí‚¤ê²Œ í•  ìˆ˜ë„ ìˆë‹¤
        - í•˜ì§€ë§Œ ìœ„ ë°©ë²•ì€ ì„œë²„ì— refresh token & accessTokenì„ ëª¨ë‘ ì €ì¥í•˜ëŠ” ê²ƒìœ¼ë¡œ sessionì„ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼ ë‹¤ë¥¼ë°”ê°€ ì—†ë‹¤
        - ë”°ë¼ì„œ logoutì‹œ í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ refresh token ì •ë³´ë¥¼ ì‚­ì œí•˜ëŠ” ê²ƒìœ¼ë¡œ ë¡œì§ êµ¬ì„±
    - **í† í° ì¬ë°œê¸‰**
        - í† í°ì€ ìœ íš¨ ê¸°ê°„ì´ ìˆê¸° ë•Œë¬¸ì—, ê¸°ê°„ì´ ì§€ë‚¬ì„ ê²½ìš°ë¥¼ ìœ„í•´ redisì— ì €ì¥í•œ refreshTokenì˜ ë‚¨ì€ ë§Œë£Œ ê¸°ê°„ì— ë”°ë¼ accessTokenê³¼ refreshToken ë‘ ê°œ ëª¨ë‘ í˜¹ì€ accessTokenë§Œ ì¬ë°œê¸‰í•˜ê¸° ìœ„í•¨ì´ë‹¤
        - ë³¸ ì½”ë“œì—ëŠ” accessTokenë§Œ ì¬ë°œê¸‰í•˜ì˜€ë‹¤

- ë³´ì•ˆê³¼ ì‚¬ìš©ì ê²½í—˜ì€ ë°˜ë¹„ë¡€í•¨ìœ¼ë¡œ ì ì ˆí•œ í•©ì˜ì ì„ ì°¾ì•„ì•¼ í•œë‹¤

(ë³´ì•ˆ) Session & AR,RT ì„œë²„ ê´€ë¦¬  >  RT ì„œë²„ ê´€ë¦¬  > ì„œë²„ ê´€ë¦¬ X (ì‚¬ìš©ì ê²½í•¨)

ì°¸ê³  ë¸”ë¡œê·¸

[https://9keyyyy.tistory.com/48](https://9keyyyy.tistory.com/48)

[https://velog.io/@backtony/Spring-Redis-ì—°ë™í•˜ê¸°](https://velog.io/@backtony/Spring-Redis-%EC%97%B0%EB%8F%99%ED%95%98%EA%B8%B0)

[https://sjh9708.tistory.com/86](https://sjh9708.tistory.com/86)

[https://velog.io/@wisdom-one/Spring-Bootì™€-Redis-ê°„ë‹¨í•˜ê²Œ-ì—°ë™í•˜ê¸°](https://velog.io/@wisdom-one/Spring-Boot%EC%99%80-Redis-%EA%B0%84%EB%8B%A8%ED%95%98%EA%B2%8C-%EC%97%B0%EB%8F%99%ED%95%98%EA%B8%B0)

### [RedisTemplate](https://kobumddaring.tistory.com/61\)

- redisì— ë°ì´í„°ë¥¼ ë„£ê³  ë°›ê¸° ìœ„í•œ ì¸í„°í˜ì´ìŠ¤
- byte[]ë¡œ ì •ë³´ë¥¼ ì£¼ê³  ë°›ê¸° ë•Œë¬¸ì— ì§ë ¬í™”ë¥¼ ìœ„í•œ ì„¤ì •ì„ í•´ì£¼ì–´ì•¼ í•œë‹¤
- ë§Œì•½ key, value ëª¨ë‘ Stringì´ë¼ë©´ StringRedisTemplateë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤

```java
@RequiredArgsConstructor
@Configuration
@EnableRedisRepositories
public class RedisConfig {
    private final RedisProperties redisProperties;

    // RedisPropertiesë¡œ yamlì— ì €ì¥í•œ host, portë¥¼ ì—°ê²°
    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory(redisProperties.getHost(), redisProperties.getPort());
    }

    // serializer ì„¤ì •ìœ¼ë¡œ redis-clië¥¼ í†µí•´ ì§ì ‘ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
		// ì•„ë‹ˆë©´ key, value ëª¨ë‘ byte[]ë¡œ í•´ì•¼í•¨
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        **RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();**
        **redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new StringRedisSerializer());**
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        return redisTemplate;
    }
}
```

# ğŸ˜œÂ Todayâ€™s Small Happiness

# ğŸ§Â Letâ€™s Think About It

# ğŸ™€Â Got Stuck..