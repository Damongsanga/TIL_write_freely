# TIL (Today I Learned)

# 1ì›” 16ì¼ í™”ìš”ì¼

# ğŸ˜ƒÂ What I Learned

## í”„ë¡œì íŠ¸ 7ì¼ì°¨

### ì§„í–‰ì¤‘

- ìƒì„± APIì—ì„œ id ê°’ ë¦¬í„´í•˜ë„ë¡ ìˆ˜ì •
- ì§€ë¼ ìŠ¤í”„ë¦°íŠ¸ ì„¤ì •
- room curd ì‘ì„±ì¤‘
- room - member ì—°ê²°ì¤‘

### **ì‹ë³„ ê´€ê³„ + ë³µí•©í‚¤ë¥¼ ì‚­ì œí•´ì•¼ë˜ë‚˜?**

- **ê³ ë¯¼**
    1. **ì‹ë³„ê´€ê³„ + ë³µí•©í‚¤ë¥¼ PK â‡’ í…Œì´ë¸” ìœ ì—°í•˜ì§€ ì•ŠìŒ â‡’ ì¼ë‹¨ ì´ê±¸ë¡œ ã„±ã„±**
    2. **ë¹„ì‹ë³„ê´€ê³„ + ë³µí•©í‚¤ & ë”°ë¡œ ë³„ë„ PK â‡’ êµ¬í˜„ ëª»í•˜ê² ìŒ;;**
        - ì•„ë˜ ì½”ë“œ ì•ˆë¨;;
        - code
            
            ```java
            @Entity
            public class RoomMember {
            
                @Id
                @GeneratedValue(strategy = GenerationType.IDENTITY)
                private Long id;  // ë³„ë„ì˜ ê¸°ë³¸ í‚¤
            
                @Embedded
                private RoomMemberId roomMemberId;  // ë³µí•©í‚¤
            
                @ManyToOne
                @JoinColumn(name = "member_id", insertable = false, updatable = false)
                private Member member;
            
                @ManyToOne
                @JoinColumn(name = "room_id", insertable = false, updatable = false)
                private Room room;
            
                // ë‚˜ë¨¸ì§€ í•„ë“œë“¤...
            
                // Constructors, getters, setters ë“±...
            }
            ```
            
    3. **ê·¸ëƒ¥ ë¹„ì‹ë³„ê´€ê³„ & ë”°ë¡œ ë³„ë„ PK â‡’ í…Œì´ë¸” ìœ ì—°í•œë° unique í™•ì¸ì„ ëª»í•˜ê² ìŒ**
- ì‹ë³„ ê´€ê³„ + ë³µí•©í‚¤ì˜ íŠ¹ì§•
    
    [https://milenote.tistory.com/119](https://milenote.tistory.com/119)
    
    - â€¢ **ë¹„ì‹ë³„ ê´€ê³„ë¥¼ ì‚¬ìš©**í•˜ê³  ê¸°ë³¸ í‚¤ëŠ”Â **Long íƒ€ì…ì˜ ëŒ€ë¦¬ í‚¤ë¥¼Â ì‚¬ìš©**í•˜ëŠ” ê²ƒì„ ì¶”ì²œ
    - ì‹ë³„ ê´€ê³„ëŠ” ë¶€ëª¨ í…Œì´ë¸” ê¸°ë³¸ í‚¤ë¥¼ ìì‹ í…Œì´ë¸”ë¡œ ì „íŒŒí•˜ë©° ìì‹ í…Œì´ë¸”ì˜ ê¸°ë³¸ í‚¤ ì»¬ëŸ¼ ì¦ê°€
    - 2ê°œ ì´ìƒì˜ ì»¬ëŸ¼ì„ í•©í•´ ë³µí•© ê¸°ë³¸ í‚¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ë¹ˆë²ˆ
    - ì‹ë³„ ê´€ê³„ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ê°€ ìˆëŠ” ìì—° í‚¤ ì»¬ëŸ¼ì„ ì¡°í•© ë°˜ë©´, ë¹„ì‹ë³„ ê´€ê³„ì˜ ê¸°ë³¸í‚¤ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ì™€ ê´€ê³„ì—†ëŠ” ëŒ€ë¦¬ í‚¤ë¥¼ ì‚¬ìš© â†’ **ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ì€ ì‹œê°„ì´ ì§€ë‚˜ë©´ ë³€ê²½ë˜ë¯€ë¡œ ìì—°í‚¤ê°€ ì „íŒŒë˜ë©´ ë³€ê²½ì´ ì–´ë ¤ì›€**
    - ì‹ë³„ ê´€ê³„ëŠ” ë¹„ì‹ë³„ ê´€ê³„ë³´ë‹¤ í…Œì´ë¸” êµ¬ì¡°ê°€ ìœ ì—°í•˜ì§€ ëª»í•¨
    
    ```java
    @Entity
    @Getter
    public class RoomMember {
    
        @EmbeddedId
        private RoomMemberId id;
    
        @ManyToOne
        @MapsId("memberId")
        @JoinColumn(name="member_id")
        private Member member;
    
        @ManyToOne
        @MapsId("roomId")
        @JoinColumn(name="room_id")
        private Room room;
    
        protected RoomMember(){
    
        }
    
        public RoomMember(Member member, Room room) {
            setId(member, room);
            this.member = member;
            this.room = room;
            joinRoom();
        }
    
        public void setId(Member member, Room room){
            this.id = new RoomMemberId(member.getMemberId(), room.getId());
        }
    
        public void joinRoom(){
            this.member.addRoomMember(this);
            this.room.addRoomMember(this);
        }
    
        public void leaveRoom(){
            this.member.removeRoomMember(this);
            this.room.removeRoomMember(this);
       }
    }
    ```
    
    ```java
    package com.a506.comeet.room.entity;
    
    import jakarta.persistence.*;
    import lombok.Getter;
    
    import java.io.Serializable;
    import java.util.Objects;
    
    @Embeddable
    @Getter
    public class RoomMemberId implements Serializable {
    
        private String memberId;
        private Long roomId;
    
        protected RoomMemberId() {
        }
    
        public RoomMemberId(String memberId, Long roomId) {
            this.memberId = memberId;
            this.roomId = roomId;
        }
    
        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (o == null || getClass() != o.getClass()) return false;
            RoomMemberId that = (RoomMemberId) o;
            return Objects.equals(memberId, that.memberId) && Objects.equals(roomId, that.roomId);
        }
    
        @Override
        public int hashCode() {
            return Objects.hash(memberId, roomId);
        }
    }
    ```
    

## ì˜¤ëŠ˜ ë§‰íŒ ë¶€ë¶„

- í…ŒìŠ¤íŠ¸ì—ì„œ ì¤‘ê°„ í…Œì´ë¸” ì–‘ë±¡í–¥ ì—°ê´€ í¸ì˜ ë©”ì†Œë“œ ì ìš© ì•ˆë¨
- ì´ìœ ëŠ” ê°„ë‹¨í–ˆë‹¤.. ìƒì„±ëœ newRoomì€ em.find()í•œ ê°ì²´ê°€ ì•„ë‹ˆë¼ì„œ ì–‘ë°©í–¥ ë§¤í•‘ì´ ì ìš©ë˜ì§€ ì•Šì•˜ë˜ê²ƒ
    - **ì¦‰, ì‹¤ì œë¡œëŠ” ì–‘ë°©í–¥ ë§¤í•‘ì´ ë˜ì—ˆìœ¼ë‚˜ ì´ìƒí•œ ê°ì²´ë¥¼ ì¡°íšŒí•˜ê³  ìˆì—ˆë˜ ê²ƒì´ë‹¤**

```java
@Test
@DisplayName("ìœ ì €ê°€ ë°©ì— ê°€ì…í•œë‹¤")
void joinTest(){
    //given
    // Manager ë©¤ë²„ ìƒì„±
    Member manager = Member.builder().memberId("ë©¤ë²„1").build();
    em.persist(manager);
    em.flush();
    em.clear();

    //ë°© ìƒì„±
    RoomCreateRequestDto reqR = RoomCreateRequestDto.builder().
            mangerId(manager.getMemberId()).
            title("title").description("ì„¤ëª…").capacity(10).constraints(RoomConstraints.FREE.get()).type(RoomType.PERMANENT.get()).
            build();
    Room newRoom = roomService.createRoom(reqR);
    // ìƒì„±ëœ ë°©ì˜ id
    Long roomId = newRoom.getId();

    // ê°€ì…í•  ë©¤ë²„ ìƒì„±
    Member member = Member.builder().memberId("member1").build();
    em.persist(member);
    em.flush();
    em.clear();

    // when
    // ë©¤ë²„ë¥¼ ë°©ì— ê°€ì…ì‹œí‚´
    RoomJoinRequestDto req = new RoomJoinRequestDto("member1");
    **roomService.joinMember(req, roomId); // roomMemberë¥¼ ë§Œë“¤ì—ˆëŠ”ë°**
    log.info("memberì˜ roomMember : {}", member.getRoomMembers());
****
    //assert
		**// newRoomì˜ roomMembersì— roomMemberê°€ ë“¤ì–´ê°€ì§€ ì•ŠëŠ”ë‹¤!**
    **assertThat(newRoom.getRoomMembers().get(0).getMember().getMemberId()).isEqualTo("member1");
    assertThat(newRoom.getRoomMembers().size()).isEqualTo(1);
    assertThat(newRoom.getRoomMembers().get(0).getRoom().getTitle()).isEqualTo("title");**
}
```

- **ì›ì¸ì„ ì°¾ì•„ë³´ì**
    - RoomService

```java
@Transactional
public void joinMember(RoomJoinRequestDto req, long roomId) {
    **Room room = roomRepository.findById(roomId).get(); // entityManagerê°€ ê´€ë¦¬í•˜ëŠ” roomì„ ì¡°íšŒ**
    if (room.getType().equals(RoomType.DISPOSABLE.get())) return;

    **Member member = memberRepository.findById(req.getMemberId()).get(); // entityManagerê°€ ê´€ë¦¬í•˜ëŠ” memberì„ ì¡°íšŒ**
    **RoomMember roomMember = new RoomMember(member, room); // ê·¸ room, memberë¡œ roomMemberë¥¼ ë§Œë“¦**
}
```

- ì–‘ë°©í–¥ ë§¤í•‘ì„ êµ¬í˜„í•´ë‘ì—ˆë‹¤
    - RoomMember

```java
public RoomMember(Member member, Room room) {
    setId(member, room);
    this.member = member;
    this.room = room;
    **joinRoom(); //ì–‘ë°©í–¥ ë§¤í•‘**
}

public void setId(Member member, Room room){
    this.id = new RoomMemberId(member.getMemberId(), room.getId());
}

**public void joinRoom(){
    this.member.addRoomMember(this); // "entityManagerê°€ ê´€ë¦¬í•´ì£¼ëŠ” member"ì— ì–‘ë°©í–¥ ë§¤í•‘í•¨
    this.room.addRoomMember(this);
}**
```

- ìˆ˜ì •í•´ë³´ì

```java
// when
// ë©¤ë²„ë¥¼ ë°©ì— ê°€ì…ì‹œí‚´
RoomJoinRequestDto req = new RoomJoinRequestDto("member1");
roomService.joinMember(req, roomId);
log.info("memberì˜ roomMember : {}", member.getRoomMembers());
**Room room = roomRepository.findById(roomId).get(); // "entityManagerê°€ ê´€ë¦¬í•˜ëŠ” room"ì„ í™•ì¸í•´ì•¼í•œë‹¤** 

//assert
assertThat(room.getRoomMembers().get(0).getMember().getMemberId()).isEqualTo("member1");
assertThat(room.getRoomMembers().size()).isEqualTo(1);
assertThat(room.getRoomMembers().get(0).getRoom().getTitle()).isEqualTo("title");
**// ìƒˆë¡œ ìƒì„±ëœ ë°©ì€ ìœ„ì˜ serviceì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì ìš©ë˜ì§€ ì•Šì•˜ë‹¤!!**
**assertThat(newRoom.getRoomMembers().size()).isEqualTo(0);**
```

### ë‚´ì¼ ì§„í–‰í•´ì•¼ í•  ê²ƒ

- Validation ì¡°ê±´ ì •ë¦¬í•˜ì—¬ ì ìš© í•„ìš”
    - ì–´ë””ì„œ í•  ê²ƒì¸ì§€.  ì•„ì˜ˆ service ë‹¨ì—ì„œë¶€í„° ëª»ë“¤ì–´ê°€ê²Œ í•  ê²ƒì¸ì§€? ì•„ë‹ˆë©´ ì €ì¥í•˜ë˜ ì‹¤íŒ¨í•˜ë„ë¡ í•  ê²ƒì¸ì§€
- Room - Channel/Lounge ì–‘ë°©í–¥ ë§¤í•‘ì´ í•„ìš”í•œì§€ ê³ ë¯¼

## ê³µë¶€í•˜ë‹¤ ì•ˆ ê²ƒë“¤

### ë³µí•©í‚¤ ì‚¬ìš©ë²•

- @EmbeddedId
- @Embedded
- @MappedSuperClass
- Serializable
- equals, hashcode í•„ìˆ˜ êµ¬í˜„

### Config ì‘ì„±í•´ì•¼í•˜ë‚˜? EntityManager ëŠ” ì–´ë””ìˆì§€?

- **Spring Data JPA ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ ì£¼ì…**
- toggle
    
    springboot data jpaì— ìë™ ì£¼ì…ë˜ì–´ìˆë‹¤ê³  ìƒê°í•´ë„ ë¼?
    
    **ChatGPT**
    
    **ë„¤, ë§ìŠµë‹ˆë‹¤. Spring Bootì™€ Spring Data JPAë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, `EntityManager`ëŠ” ìë™ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ì£¼ì…ë©ë‹ˆë‹¤.**
    

### **@JoinColumn**

```java
// Member
@OneToMany(mappedBy = "member")
private List<Order> orders = new ArrayList<>();

// Order
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name="member_id")
private Member member;
```

- @Columnê³¼ ê°™ì´ í…Œì´ë¸”ì— ì €ì¥ë  ì»¬ëŸ¼ëª…ì„ ì§€ì •í•´ì£¼ëŠ” ê²ƒ (ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì´ë‹ˆê¹Œ ì‹¤ì œ ì»¬ëŸ¼ì´ ì¡´ì¬í•œë‹¤)
- ë°˜ë“œì‹œ í…Œì´ë¸”ì— ë§ì¶°ì„œ ì €ì¥í•˜ì§€ ì•Šì•„ë„ ëœë‹¤
- ì—°ê´€ê´€ê³„ëŠ” ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆëŠ” ê±´ê°€..?
- referencedColumnName
    - **referencedColumnNameÂ ì†ì„±ì„ ìƒëµí•˜ë©´ ìë™ìœ¼ë¡œ ëŒ€ìƒ í…Œì´ë¸”ì˜ pk ê°’ìœ¼ë¡œ ì§€ì • ë˜ê¸° ë•Œë¬¸**ì…ë‹ˆë‹¤.

### JPA ì£¼ì˜ì 

- Entity ê¸°ë³¸ ìƒì„±ì
- @Embeddableë„ ê¸°ë³¸ ìƒì„±ì í•„ìš”
- oneToMany List ë¯¸ë¦¬ ì´ˆê¸°í™”
    
    ```java
    @OneToMany(mappedBy = "member")
    private List<RoomMember> roomMembers = new ArrayList<>();
    ```
    
- `fetch = FetchType.*LAZY*`
    - toManyëŠ” defaultê°€ LAZY
    - **toOneì€ defaultê°€ EAGERë‹¤ â‡’ ë‹¤ LAZYë¡œ ë°”ê¿”**
        - **OneToOne**
        - **ManyToOne**

## ì•Œê³ ë¦¬ì¦˜

[íŠ¸ë¦¬ì˜ ì§€ë¦„](https://www.notion.so/d8f9f0af2a644ea8a05721ffee4ad748?pvs=21)

## ê³µë¶€ë‚´ìš©

- Spring Security ì§„í–‰ì¤‘

# ğŸ˜œÂ Todayâ€™s Small Happiness

# ğŸ§Â Letâ€™s Think About It

# ğŸ™€Â Got Stuck..

-