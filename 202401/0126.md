# TIL (Today I Learned)

# 1ì›” 26ì¼ ê¸ˆìš”ì¼

# ğŸ˜ƒÂ What I Learned

## í”„ë¡œì íŠ¸ 15ì¼ì°¨

### ì§„í–‰ ë‚´ìš©

### ì˜¤ëŠ˜ í•œ ë‚´ìš©

- [x]  token ì¶”ê°€ ì•”í˜¸í™” (accessë„ ì•„ë‹ˆë©´ refresh ë™ì‹œì—?)

[https://green-bin.tistory.com/50](https://green-bin.tistory.com/50)

[https://geonoo.tistory.com/14](https://geonoo.tistory.com/14)

[https://green-bin.tistory.com/76](https://green-bin.tistory.com/76)

[https://new.atsit.in/1346/](https://new.atsit.in/1346/)

- [x]  filter ë‹¨ì—ì„œì˜ custom error í™•ì¸
- [x]  ì¤‘ê°„ë°œí‘œ

### ë‚´ì¼ í•  ë‚´ìš©

- [ ]  Refactoring
    - [ ]  DTO & SERVICE ë“± convention í†µì¼
    - [ ]  @Where Entityì— ì ìš©í•˜ê³  findByIdAndIsDeletedFalse ì „ë¶€ findByIdë¡œ ìˆ˜ì •í•˜ê¸°
    - [ ]  EnterRoomì— Keywordë„ ì¶”ê°€
    - [ ]  service ë‹¨ì—ì„œ methodëª… ì‹¬í”Œí•˜ê²Œ
    - [ ]  reqMemberIdê¼­ í•„ìš”í•œê±°ë§Œ
    - [ ]  dto > reqë¡œ ì „ë¶€ ë°”ê¾¸ê¸°
    - [ ]  @PathVariable long â†’ Longìœ¼ë¡œ ìˆ˜ì •
    - [ ]  ì–‘ë°©í–¥ ì‚­ì œ ë©”ì„œë“œ
        
        ```java
        public void delete(){
                deleteSoftly();
                this.getLounges().forEach(Lounge::deleteSoftly);
                this.getChannels().forEach(Channel::deleteSoftly);
                this.getRoomKeywords().forEach(RoomKeyword::deleteSoftly);
                this.getRoomMembers().forEach(RoomMember::deleteSoftly);
                this.lounges = new ArrayList<>();
                this.channels = new ArrayList<>();
                this.roomKeywords = new ArrayList<>();
                this.roomMembers = new ArrayList<>();
            }
        ```
        

## ì˜¤ëŠ˜ ë§‰íŒ ë¶€ë¶„

- ë§ˆì§€ë§‰ì— ë¹„ì •ìƒì ì¸ access tokenì„ ë³´ëƒˆì„ ë•Œ ë¦¬í„´ ì—ëŸ¬ê°’ì´ custom error í˜•ì‹ì´ ì•„ë‹˜
    - ë¡œì§ í™•ì¸ í•„ìš”

## í•´ê²°í•œ ë¶€ë¶„

### í•„í„°ë‹¨ì—ì„œì˜ ì—ëŸ¬ ì²˜ë¦¬ ë° CustomError ë°˜í™˜

- í•„í„°ë‹¨ì—ì„œ ì—ëŸ¬ê°€ í•¸ë“¤ë§ë˜ë©´ `ResponseEntityExceptionHandler` ë¥¼ ìƒì†í•œ `GlobalExceptionHandler` ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤
    - `@RestControllerAdvice` ì˜ ì—ëŸ¬ ì²˜ë¦¬ ë²”ìœ„ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ ë‚´ ì»¨íŠ¸ë¡¤ëŸ¬ë‹¨ê¹Œì§€ì´ë‹¤
- ì´ë¥¼ ìœ„í•´ JwtAuthenticationFilter ì•ì— JwtExceptionFilterë¥¼ ë§Œë“¤ì–´ ì—ëŸ¬ë¥¼ í¬í•¨í•˜ì—¬ ë°˜í™˜ë˜ëŠ” ì‘ë‹µì— ì—ëŸ¬ë¥¼ catchí•˜ì—¬ CustomErrorë¡œ ìˆ˜ì •í•´ ì¤„ ìˆ˜ ìˆë‹¤

- JwtExceptionFilterë¥¼ Component Beanìœ¼ë¡œ ë“±ë¡í•œë‹¤
- ObjectMapperë¥¼ ë¯¸ë¦¬ Beanìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ì…í•œë‹¤

```java
@Component
@RequiredArgsConstructor
public class JwtExceptionFilter extends OncePerRequestFilter {

    private final ObjectMapper objectMapper;

    @Override
    protected void doFilterInternal(HttpServletRequest req, HttpServletResponse res, FilterChain chain) throws ServletException, IOException {
        try {
            chain.doFilter(req, res); // go to 'JwtAuthenticationFilter'
        } catch (JwtException ex) {
            makeErrorResponse(res);
        }
    }

    private void makeErrorResponse(HttpServletResponse res) throws IOException {
        res.setContentType("application/json;charset=UTF-8");
        res.getWriter().write(convertObjectToJson(ErrorResponse.builder()
                .code(CustomErrorCode.NOT_VALID_USER.name())
                .message(CustomErrorCode.NOT_VALID_USER.getMessage())
                .build()));
    }

    private String convertObjectToJson(Object object) throws JsonProcessingException {
        return objectMapper.writeValueAsString(object);
    }
}
```

- ErrorResponse

```java
@Getter
@Builder
@RequiredArgsConstructor
public class ErrorResponse {
    private final String code;
    private final String message;

		// Validation Errorì— ëŒ€í•œ ë¶€ë¶„ì…ë‹ˆë‹¤
    // ì—ëŸ¬ê°€ ì—†ì„ ê²½ìš° ì‘ë‹µì—ì„œ ì œì™¸
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private final List<ValidationError> errors;

    // @Validì— ì˜í•œ ì—ëŸ¬ ë°œìƒì‹œ ì–´ë–¤ í•„ë“œì—ì„œ ì—ëŸ¬ ë°œìƒí–‡ëŠ”ì§€ì— ëŒ€í•œ ì‘ë‹µ
    @Getter
    @Builder
    @RequiredArgsConstructor
    public static class ValidationError {
        private final String field;
        private final String message;

        public static ValidationError of(final FieldError fieldError) {
            return ValidationError.builder()
                    .field(fieldError.getField())
                    .message(fieldError.getDefaultMessage())
                    .build();
        }
    }
}
```

- SecurityConfigë¥¼ í†µí•´ ì¶”ê°€

```java
// SecurityConfig
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
	return 
	...

	// JWT ì¸ì¦ì„ ìœ„í•˜ì—¬ ì§ì ‘ êµ¬í˜„í•œ í•„í„°ë¥¼ UsernamePasswordAuthenticationFilter ì „ì— ì‹¤í–‰
	.addFilterBefore(new JwtAuthenticationFilter(jwtTokenProvider), UsernamePasswordAuthenticationFilter.class)
	// JwtException í•¸ë“¤ë§ì„ ìœ„í•œ Exception í•„í„°ë¥¼ JwtAuthenticationFilter ì „ì— ë°°ì¹˜ (ì‘ë‹µ ê¸°ì¤€ìœ¼ë¡œ ì´í›„ì— ì‹¤í–‰)
	.addFilterBefore(new JwtExceptionFilter(objectMapper), JwtAuthenticationFilter.class).build();
}
```

```java
{
    "code": "NOT_VALID_USER",
    "message": "ì‚¬ìš©ì ê¶Œí•œì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
}
```

# ğŸ˜œÂ Todayâ€™s Small Happiness

# ğŸ§Â Letâ€™s Think About It

# ğŸ™€Â Got Stuck..